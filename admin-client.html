<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clients</title>
  <link rel="stylesheet" href="admin-client.css">
  <link href="https://fonts.googleapis.com/css2?family=Rowdies&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<!-- Navigation -->
<nav class="nav">
  <div class="logo">
    <img src="Photos/nu-logo-label.png" alt="NU Logo">
  </div>
  <div class="hamburger-menu">
    <input id="menu__toggle" type="checkbox" />
    <label class="menu__btn" for="menu__toggle">
      <span></span>
    </label>
    <ul class="menu__box">
      <li><a class="menu__item" href="admin-home.html">Home</a></li>
      <li><a class="menu__item" href="#">Reserve Rooms</a></li>
      <li><a class="menu__item" href="admin-logs.html">Logs</a></li>
      <li><a class="menu__item" href="#">Available Rooms</a></li>
      <li><a class="menu__item" href="admin-client.html">Clients</a></li>
      <li><a class="menu__item" href="admin-archive.html">Archive</a></li>
      <li><a class="menu__item" href="index.html">Logout</a></li>
    </ul>
  </div>
</nav>

<!-- Clients Container -->
<div class="client-list" id="clientListContainer"></div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <form id="editForm" class="account-form" onsubmit="return false;">
    <h4 style="text-align: center;">Edit User Info</h4>
    <input type="hidden" name="user_id" id="edit-user-id" />
    
    <div class="account-form-row">
      <div>
        <label for="account-fname">First Name</label><br />
        <input type="text" id="account-fname" name="fname" />
        <button type="button" onclick="updateField('fname')">Update</button>
      </div>
      <div>
        <label for="account-lname">Last Name</label><br />
        <input type="text" id="account-lname" name="lname" />
        <button type="button" onclick="updateField('lname')">Update</button>
      </div>
    </div>

    <div>
      <label for="account-email">Email</label><br />
      <input type="email" id="account-email" name="email" />
      <button type="button" onclick="updateField('email')">Update</button>
    </div>

    <div><h3>Change Password</h3></div>
    <div>
      <label for="account-password">Old Password</label><br />
      <input type="password" id="account-password" name="password" />
    </div>
    <div>
      <label for="account-new-password">New Password</label><br />
      <input type="password" id="account-new-password" name="new_password" />
      <button type="button" onclick="updatePassword()">Update Password</button>
    </div>

    <div class="submit-row">
      <button type="button" onclick="closeEditForm()">Cancel</button>
    </div>
  </form>
</div>

<script>
  function fetchUsers() {
    fetch("fetch_users.php")
      .then(res => res.json())
      .then(data => displayUsers(data))
      .catch(err => {
        console.error("Fetch error:", err);
        alert("Failed to load users.");
      });
  }

function displayUsers(users) {
  const container = document.getElementById("clientListContainer");
  container.innerHTML = "";
  if (users.length === 0) {
    container.innerHTML = "<p>No users found.</p>";
    return;
  }

  users.forEach(user => {
    const card = document.createElement("div");
    card.className = "client-card";
    card.innerHTML = `
      <h3>${user.fname} ${user.lname}</h3>
      <p>${user.email}</p>
      <p>ID: ${user.user_id}</p>
      <div class="button-container">
        <button onclick="openEditForm(${user.user_id}, '${user.fname}', '${user.lname}', '${user.email}')">Edit</button>
        <button onclick="deleteUser(${user.user_id})">Delete</button>
      </div>
    `;
    container.appendChild(card);
  });
}

function openEditForm(userId, fname, lname, email) {
  document.getElementById("edit-user-id").value = userId;
  document.getElementById("account-fname").value = fname;
  document.getElementById("account-lname").value = lname;
  document.getElementById("account-email").value = email;
  document.getElementById("editModal").classList.add("active");
}

function closeEditForm() {
  document.getElementById("editModal").classList.remove("active");
  document.getElementById("account-password").value = "";
  document.getElementById("account-new-password").value = "";
}

  function updateField(fieldName) {
    const userId = document.getElementById("edit-user-id").value;
    const value = document.getElementById("account-" + fieldName).value;
    const formData = new FormData();
    formData.append("user_id", userId);
    formData.append(fieldName, value);

    fetch("admin-update_account.php", {
      method: "POST",
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) {
          fetchUsers();
          closeEditForm();
        }
      })
      .catch(err => {
        console.error("Error:", err);
        alert("Update failed.");
      });
  }

  function updatePassword() {
    const userId = document.getElementById("edit-user-id").value;
    const oldPass = document.getElementById("account-password").value;
    const newPass = document.getElementById("account-new-password").value;

    if (!oldPass || !newPass) {
      alert("Please fill out both password fields.");
      return;
    }

    const formData = new FormData();
    formData.append("user_id", userId);
    formData.append("password", oldPass);
    formData.append("new_password", newPass);

    fetch("admin-update_account.php", {
      method: "POST",
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) {
          fetchUsers();
          closeEditForm();
        }
      })
      .catch(err => {
        console.error("Password update error:", err);
        alert("Password update failed.");
      });
  }

  function deleteUser(userId) {
    if (!confirm("Are you sure you want to delete this user?")) return;

    const formData = new FormData();
    formData.append("user_id", userId);

    fetch("delete_user.php", {
      method: "POST",
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) {
          fetchUsers(); // Refresh user list
        }
      })
      .catch(err => {
        console.error("Delete error:", err);
        alert("Delete failed.");
      });
  }

  document.addEventListener("DOMContentLoaded", fetchUsers);
</script>

<script>
  document.addEventListener("keydown", function(event) {
    if (event.key === "Escape") {
      closeEditForm();
    }
  });
</script>


</body>
</html>
